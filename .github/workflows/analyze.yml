name: Analyze

on:
  pull_request:
    paths:
      - 'registry/**/calldata-*.json'

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    runs-on: public-ledgerhq-shared-small
    timeout-minutes: 360

    steps:
      - name: Checkout PR branch (for files to analyze)
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}

      - name: Checkout analyzer repository
        uses: actions/checkout@v6
        with:
          repository: LedgerHQ/erc7730-analyzer
          ref: main
          path: erc7730-analyzer

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: erc7730-analyzer/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r erc7730-analyzer/requirements.txt

      - name: Get changed calldata files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            registry/**/calldata-*.json
          separator: '\n'

      - name: Check if this is a report commit (Analysis files only)
        id: check-report-commit
        env:
          ANY_CHANGED: ${{ steps.changed-files.outputs.any_changed }}
        run: bash -e .github/scripts/analyze/check-report-commit.sh

      - name: Run analyzer on each file
        if: steps.changed-files.outputs.any_changed == 'true'
        id: run-analyzer
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          COREDAO_API_KEY: ${{ secrets.COREDAO_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: bash -e .github/scripts/analyze/run-analyzer.sh

      - name: Upload analysis reports as artifacts
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: analysis-reports
          path: output/
          retention-days: 30

      - name: Create annotations for critical issues
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: bash -e .github/scripts/analyze/annotate-criticals.sh

      - name: Add reports to job summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: bash -e .github/scripts/analyze/add-summary.sh

      - name: Post summary to PR
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const reportsDir = 'output';
            if (!fs.existsSync(reportsDir)) {
              console.log('No reports directory found');
              return;
            }

            const files = fs.readdirSync(reportsDir).filter(f => f.endsWith('.md'));

            let body = '## üîç ERC-7730 Analysis Complete\n\n';
            body += `üìä **Reports generated:** ${files.length}\n\n`;
            body += `üì• **[Download full reports (artifacts)](${context.payload.repository.html_url}/actions/runs/${context.runId})**\n\n`;

            // Add status based on critical issues
            const hasCriticals = '${{ steps.run-analyzer.outputs.has_criticals }}' === 'true';
            if (hasCriticals) {
              body += '\n## ‚ùå Status: CRITICAL ISSUES FOUND\n\n';
              body += '**This PR cannot be merged until critical issues are resolved.**\n';
              body += 'Please review the reports above and fix the identified issues.\n';
            } else {
              body += '\n## ‚úÖ Status: NO CRITICAL ISSUES\n\n';
              body += '**This PR is safe to merge** (based on automated analysis).\n';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Block merge if critical issues found
        if: always()
        run: |
          # Check if this is a report commit or a regular analysis
          if [ "${{ steps.check-report-commit.outputs.is_report_commit }}" = "true" ]; then
            # Report commit - use the check-report-commit result
            if [ "${{ steps.check-report-commit.outputs.has_criticals }}" = "true" ]; then
              echo "::error::‚ùå BLOCKING MERGE - Critical issues found in committed reports"
              exit 1
            else
              echo "‚úÖ No critical issues in reports - merge allowed"
              exit 0
            fi
          else
            # Regular analysis - use the run-analyzer result
            if [ "${{ steps.run-analyzer.outputs.has_criticals }}" = "true" ]; then
              echo "::error::‚ùå BLOCKING MERGE - Critical issues found in analysis"
              exit 1
            else
              echo "‚úÖ No critical issues - merge allowed"
              exit 0
            fi
          fi
